<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Tracker de jornadas Uber Moto">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <title>Uber Moto Tracker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Urbanist:wght@400;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-orange: #fb923c;
            --accent-blue: #60a5fa;
            --accent-red: #f87171;
            --accent-green: #4ade80;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        
        body {
            font-family: 'Urbanist', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }
        
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 1.5rem 1rem;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .header-content {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .header-stats {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-pill {
            flex: 1;
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .input-field {
            width: 100%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 0.875rem 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.1);
        }
        
        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Urbanist', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-orange), #f97316);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--accent-green), #22c55e);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red), #ef4444);
            color: white;
        }
        
        .wallet-inputs {
            display: grid;
            gap: 1rem;
        }
        
        .wallet-input {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid var(--border);
        }
        
        .wallet-name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .active-journey {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 2px solid var(--accent-orange);
        }
        
        .journey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .journey-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-orange);
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .quick-btn {
            padding: 1.25rem 1rem;
            border: 2px solid;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
            color: var(--text-primary);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .quick-btn:active {
            transform: scale(0.95);
        }
        
        .quick-btn.fuel {
            border-color: var(--accent-orange);
        }
        
        .quick-btn.moto {
            border-color: var(--accent-blue);
        }
        
        .quick-btn.personal {
            border-color: var(--accent-red);
        }
        
        .quick-btn.income {
            border-color: var(--accent-green);
            grid-column: 1 / -1;
        }
        
        .earnings-display {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(34, 197, 94, 0.1));
            border: 2px solid var(--accent-green);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .earnings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .earnings-row:last-child {
            margin-bottom: 0;
            padding-top: 0.75rem;
            border-top: 1px solid var(--accent-green);
        }
        
        .earnings-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .earnings-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .earnings-value.large {
            font-size: 1.5rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            border: 2px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .close-btn:hover {
            background: var(--bg-tertiary);
        }
        
        .payment-method-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .payment-option {
            padding: 0.875rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-tertiary);
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .payment-option.selected {
            border-color: var(--accent-orange);
            background: rgba(251, 146, 60, 0.1);
        }
        
        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }
        
        .history-item {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .history-date {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .history-earning {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--accent-green);
            font-size: 1.1rem;
        }
        
        .history-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .history-detail {
            display: flex;
            justify-content: space-between;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 2px solid var(--border);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 0.5rem;
            z-index: 99;
        }
        
        .nav-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 0.25rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.65rem;
            font-weight: 600;
            transition: all 0.2s;
            border-radius: 8px;
        }
        
        .nav-btn.active {
            color: var(--accent-orange);
            background: rgba(251, 146, 60, 0.1);
        }
        
        .nav-icon {
            font-size: 1.3rem;
        }
        
        .expense-list {
            margin-top: 1rem;
        }
        
        .expense-item {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .expense-concept {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        .expense-amount {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }
        
        .expense-amount.fuel {
            color: var(--accent-orange);
        }
        
        .expense-amount.moto {
            color: var(--accent-blue);
        }
        
        .expense-amount.personal {
            color: var(--accent-red);
        }
        
        .dashboard-grid {
            display: grid;
            gap: 1rem;
        }
        
        .progress-card {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.1), rgba(249, 115, 22, 0.1));
            border: 2px solid var(--accent-orange);
        }
        
        .progress-bar {
            background: var(--bg-tertiary);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, var(--accent-orange), var(--accent-red));
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 6px;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .stat-card {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .stat-card-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .stat-card-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .km-display {
            display: flex;
            justify-content: space-between;
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .uber-counter {
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(59, 130, 246, 0.1));
            border: 2px solid var(--accent-blue);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .uber-counter-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .uber-counter-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">üèçÔ∏è UBER MOTO TRACKER</div>
            <div class="header-stats">
                <div class="stat-pill">
                    <div class="stat-label">Mes Actual</div>
                    <div class="stat-value" id="monthTotal">$0</div>
                </div>
                <div class="stat-pill">
                    <div class="stat-label">Promedio/D√≠a</div>
                    <div class="stat-value" id="dailyAvg">$0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="screen active">
        <div class="container">

            <!-- 1. MANTENIMIENTO -->
            <div class="card" style="border: 1px solid var(--border); cursor:pointer;" onclick="switchScreen('mantenimiento')">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div class="card-title" style="margin-bottom:0.25rem;">üîß Mantenimiento</div>
                        <div style="font-size:0.8rem; color:var(--text-secondary);" id="nextMaintenancePreview">Cargando alertas...</div>
                    </div>
                    <div style="font-size:1.5rem; color:var(--text-secondary);">‚Ä∫</div>
                </div>
            </div>

            <!-- 2. MDA -->
            <div class="card" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.1), rgba(249, 115, 22, 0.1)); border: 2px solid var(--accent-orange);">
                <div class="card-title">üéØ Meta Diaria Ajustada</div>
                <div style="text-align: center; margin: 1rem 0;">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">NECESITAS RECAUDAR POR D√çA</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700; color: var(--accent-orange);" id="dailyGoalDynamic">$0</div>
                </div>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                        <span>Para cubrir cuota:</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;" id="neededForQuota">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                        <span>Gastos operativos estimados:</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;" id="estimatedOperativeExpenses">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid var(--border); font-size: 0.85rem;">
                        <span>D√≠as restantes del mes:</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--accent-orange);" id="daysRemaining">0</span>
                    </div>
                </div>
                <div id="goalStatus" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; font-size: 0.85rem; text-align: center; font-weight: 600;"></div>
            </div>

            <!-- 3. RECAUDACI√ìN DEL MES -->
            <div class="card progress-card">
                <div class="card-title">üí∞ Recaudaci√≥n del Mes</div>
                <div class="progress-text">
                    <span>Recaudado (Bruto): <strong id="progressAmount">$0</strong></span>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                        <span>Cuota Moto:</span>
                        <span style="color: var(--accent-red); font-weight: 700;">-$475,648</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                        <span>Combustible:</span>
                        <span style="color: var(--accent-orange); font-weight: 700;" id="totalFuel">-$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                        <span>Gastos Moto:</span>
                        <span style="color: var(--accent-blue); font-weight: 700;" id="totalMoto">-$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid var(--border); font-weight: 700;">
                        <span>Disponible Real:</span>
                        <span style="color: var(--accent-green); font-size: 1.1rem;" id="realAvailable">$0</span>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(96, 165, 250, 0.1); border-radius: 8px; border: 1px solid var(--accent-blue);">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">GASTOS PERSONALES (a devolver)</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; color: var(--accent-blue);" id="totalPersonal">$0</div>
                </div>
            </div>

            <!-- 4. FRASCOS -->
            <div class="card" style="background: linear-gradient(135deg, rgba(251,146,60,0.05), rgba(74,222,128,0.05)); border: 1px solid var(--border);">
                <div class="card-title">ü´ô Frascos del Mes</div>
                <div style="margin-bottom:1rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.4rem;">
                        <div style="font-size:0.8rem; font-weight:700; color:var(--accent-orange);">üè¶ Frasco Cuota</div>
                        <div style="font-size:0.75rem; color:var(--text-secondary);" id="frascoCuotaPct">0%</div>
                    </div>
                    <div style="background:var(--bg-tertiary); border-radius:8px; height:10px; overflow:hidden; margin-bottom:0.4rem;">
                        <div id="frascoCuotaBar" style="height:100%; background:linear-gradient(90deg, var(--accent-orange), var(--accent-green)); border-radius:8px; transition:width 0.5s ease; width:0%;"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <div style="font-family:'JetBrains Mono',monospace; font-size:1rem; font-weight:700; color:var(--accent-orange);" id="frascoCuotaAmount">$0</div>
                        <div style="font-size:0.75rem; color:var(--text-secondary); align-self:center;" id="frascoCuotaFalta">Meta: $475,648</div>
                    </div>
                </div>
                <div style="padding-top:0.75rem; border-top:1px solid var(--border);">
                    <div style="font-size:0.8rem; font-weight:700; color:var(--accent-green); margin-bottom:0.4rem;">üí∞ Frasco Ahorro <span style="font-size:0.65rem; color:var(--text-secondary); font-weight:400;">(lo que supera $30k/d√≠a)</span></div>
                    <div style="font-family:'JetBrains Mono',monospace; font-size:1.1rem; font-weight:700; color:var(--accent-green);" id="frascoAhorroAmount">$0</div>
                    <div style="font-size:0.72rem; color:var(--text-secondary); margin-top:0.2rem;" id="frascoAhorroJornadas">‚Äî</div>
                </div>
            </div>

            <!-- 5. STATS -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-label">Jornadas Mes</div>
                    <div class="stat-card-value" id="journeyCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Promedio/D√≠a (Bruto)</div>
                    <div class="stat-card-value" id="dailyAvgBruto">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Promedio/D√≠a (Neto)</div>
                    <div class="stat-card-value" id="dailyAvgNeto">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">KM Totales</div>
                    <div class="stat-card-value" id="totalKm">0</div>
                </div>
                <div class="stat-card" style="grid-column: 1 / -1;">
                    <div class="stat-card-label">Proyecci√≥n Final (si sigues as√≠)</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Recaudaci√≥n:</div>
                            <div class="stat-card-value" style="font-size: 1.1rem;" id="projectionBruto">$0</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Disponible:</div>
                            <div class="stat-card-value" style="font-size: 1.1rem; color: var(--accent-green);" id="projectionNeto">$0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. JORNADA -->
            <div class="card" id="activeJourneyCard" style="display: none;">
                <div class="card-title">üî• Jornada Activa</div>
                <button class="btn btn-primary" onclick="goToJourney()">Ver Jornada Actual</button>
            </div>

            <div class="card" id="noActiveJourneyCard">
                <div class="card-title">Iniciar Nueva Jornada</div>
                <button class="btn btn-success" onclick="showStartJourneyModal()">Comenzar Jornada</button>
            </div>

        </div>
    </div>

    <!-- Journey Screen -->
    <div id="journeyScreen" class="screen">
        <div class="container">
            <div class="card active-journey">
                <div class="journey-header">
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Jornada activa</div>
                        <div class="journey-time" id="journeyTimer">00:00:00</div>
                    </div>
                </div>

                <div class="uber-counter">
                    <div class="uber-counter-label">Contador Uber</div>
                    <div class="uber-counter-value" id="uberCounter">$0</div>
                    <button class="btn btn-primary" style="margin-top: 1rem;" onclick="updateUberCounter()">Actualizar Contador</button>
                </div>

                <div style="background: rgba(139, 92, 246, 0.1); border: 2px solid #a78bfa; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Saldo en Uber Wallet</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; color: #a78bfa;" id="currentUberWallet">$0</div>
                        </div>
                        <div style="text-align: right; font-size: 0.75rem; color: var(--text-secondary);">
                            üí° Transfiere a NX<br>cuando llegue a MP
                        </div>
                    </div>
                </div>

                <div style="background: rgba(59, 130, 246, 0.1); border: 2px solid #3b82f6; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Saldo Mercado Pago</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; color: #3b82f6;" id="currentMP">$0</div>
                        </div>
                        <div style="text-align: right; font-size: 0.75rem; color: var(--text-secondary);">
                            üü¶ Dep√≥sitos UW<br>llegan aqu√≠ los lunes
                        </div>
                    </div>
                </div>

                <div class="km-display">
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">KM Inicial</div>
                        <div style="font-size: 1.2rem; font-weight: 700;" id="kmStart">0</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">KM Recorridos</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-orange);" id="kmTraveled">0</div>
                    </div>
                </div>

                <div class="earnings-display">
                    <div class="earnings-row">
                        <span class="earnings-label">Ganancia Bruta</span>
                        <span class="earnings-value" id="brutaValue">$0</span>
                    </div>
                    <div class="earnings-row">
                        <span class="earnings-label">Ganancia Operativa</span>
                        <span class="earnings-value" id="operativaValue">$0</span>
                    </div>
                    <div class="earnings-row">
                        <span class="earnings-label">Ganancia Neta</span>
                        <span class="earnings-value large" id="netaValue">$0</span>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-btn fuel" onclick="showExpenseModal('fuel')">
                        ‚õΩ Combustible
                    </button>
                    <button class="quick-btn moto" onclick="showExpenseModal('moto')">
                        üîß Gasto Moto
                    </button>
                    <button class="quick-btn personal" onclick="showExpenseModal('personal')">
                        üçî Gasto Personal
                    </button>
                    <button class="quick-btn income" onclick="showIncomeModal()">
                        üí∞ Registrar Ingreso
                    </button>
                </div>

                <div class="expense-list" id="expenseList"></div>

                <button class="btn btn-danger" onclick="showEndJourneyModal()" style="margin-top: 1rem;">
                    Finalizar Jornada
                </button>
            </div>
        </div>
    </div>

    <!-- History Screen -->
    <div id="historyScreen" class="screen">
        <div class="container">
            <div class="card">
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                    <button class="btn btn-success" style="font-size: 0.85rem; padding: 0.75rem;" onclick="exportData()">üì• Exportar</button>
                    <button class="btn btn-primary" style="font-size: 0.85rem; padding: 0.75rem;" onclick="document.getElementById('importFile').click()">üì§ Importar</button>
                    <input type="file" id="importFile" accept=".json,application/json,text/plain" style="display:none" onchange="importData(event)">
                </div>
                <div class="card-title">Historial de Jornadas</div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <!-- Start Journey Modal -->
    <div id="startJourneyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Iniciar Jornada</h3>
                <button class="close-btn" onclick="closeModal('startJourneyModal')">&times;</button>
            </div>
            <div class="input-group">
                <label class="input-label">KM Inicial</label>
                <input type="number" class="input-field" id="startKm" placeholder="0">
            </div>
            <div class="wallet-inputs">
                <div class="wallet-input">
                    <div class="wallet-name">Naranja NX</div>
                    <input type="number" class="input-field" id="startNX" placeholder="$0">
                </div>
                <div class="wallet-input">
                    <div class="wallet-name">Mercado Pago</div>
                    <input type="number" class="input-field" id="startMP" placeholder="$0">
                </div>
                <div class="wallet-input">
                    <div class="wallet-name">Efectivo</div>
                    <input type="number" class="input-field" id="startCash" placeholder="$0">
                </div>
                <div class="wallet-input">
                    <div class="wallet-name">Uber Wallet</div>
                    <input type="number" class="input-field" id="startUber" placeholder="$0">
                </div>
            </div>
            <button class="btn btn-success" onclick="startJourney()">Comenzar</button>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="expenseModalTitle">Agregar Gasto</h3>
                <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="input-group">
                <label class="input-label">Monto Total</label>
                <input type="number" class="input-field" id="expenseAmount" placeholder="$0" oninput="updatePaymentDistribution()">
            </div>
            <div class="input-group" id="conceptGroup">
                <label class="input-label">Concepto</label>
                <input type="text" class="input-field" id="expenseConcept" placeholder="Ej: Mec√°nico, comida, etc.">
            </div>
            <div class="input-group">
                <label class="input-label">Distribuci√≥n de Pago</label>
                <div class="wallet-inputs">
                    <div class="wallet-input">
                        <div class="wallet-name">üíµ Efectivo</div>
                        <input type="number" class="input-field" id="expenseCash" placeholder="$0" value="0" oninput="updatePaymentDistribution('cash')">
                    </div>
                    <div class="wallet-input">
                        <div class="wallet-name">üí≥ Transferencia (NX)</div>
                        <input type="number" class="input-field" id="expenseTransfer" placeholder="$0" value="0" oninput="updatePaymentDistribution('transfer')">
                    </div>
                    <div class="wallet-input">
                        <div class="wallet-name">üü¶ Mercado Pago</div>
                        <input type="number" class="input-field" id="expenseMP" placeholder="$0" value="0" oninput="updatePaymentDistribution('mp')">
                    </div>
                </div>
                <div id="paymentWarning" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: rgba(248, 113, 113, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; font-size: 0.85rem; color: var(--accent-red);"></div>
            </div>
            <button class="btn btn-primary" onclick="addExpense()">Agregar Gasto</button>
        </div>
    </div>

    <!-- Income Modal -->
    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Registrar Ingreso</h3>
                <button class="close-btn" onclick="closeModal('incomeModal')">&times;</button>
            </div>
            <div style="background: rgba(96, 165, 250, 0.1); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-secondary);">
                üí° <strong>Tip:</strong> Registra aqu√≠ cuando recibas pagos de pasajeros o cuando transfieras de Uber Wallet a NX
            </div>
            <div class="wallet-inputs">
                <div class="wallet-input">
                    <div class="wallet-name">Incremento Naranja NX</div>
                    <input type="number" class="input-field" id="incomeNX" placeholder="$0" value="0">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">Ej: transferencias de pasajeros o desde UW</div>
                </div>
                <div class="wallet-input">
                    <div class="wallet-name">Incremento Mercado Pago</div>
                    <input type="number" class="input-field" id="incomeMP" placeholder="$0" value="0">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">Ej: dep√≥sitos de UW los lunes</div>
                </div>
                <div class="wallet-input">
                    <div class="wallet-name">Incremento Efectivo</div>
                    <input type="number" class="input-field" id="incomeCash" placeholder="$0" value="0">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">Ej: pagos en efectivo de pasajeros</div>
                </div>
                <div class="wallet-input">
                    <div class="wallet-name">Incremento Uber Wallet</div>
                    <input type="number" class="input-field" id="incomeUber" placeholder="$0" value="0">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">Ej: pagos por Mercado Pago de pasajeros</div>
                </div>
            </div>
            <button class="btn btn-success" onclick="addIncome()">Registrar</button>
        </div>
    </div>

    <!-- End Journey Modal -->
    <div id="endJourneyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Finalizar Jornada</h3>
                <button class="close-btn" onclick="closeModal('endJourneyModal')">&times;</button>
            </div>
            <div class="input-group">
                <label class="input-label">KM Final</label>
                <input type="number" class="input-field" id="endKm" placeholder="0">
            </div>
            <div class="input-group">
                <label class="input-label">Contador Uber (total del d√≠a)</label>
                <input type="number" class="input-field" id="endUberCounter" placeholder="$0">
            </div>
            <div class="wallet-inputs">
                <div class="wallet-input">
                    <div class="wallet-name">Saldo Final Naranja NX</div>
                    <input type="number" class="input-field" id="endNX" placeholder="$0">
                </div>
                <div class="wallet-input">
                    <div class="wallet-name">Saldo Final Mercado Pago</div>
                    <input type="number" class="input-field" id="endMP" placeholder="$0">
                </div>
                <div class="wallet-input">
                    <div class="wallet-name">Saldo Final Efectivo</div>
                    <input type="number" class="input-field" id="endCash" placeholder="$0">
                </div>
                <div class="wallet-input">
                    <div class="wallet-name">Saldo Final Uber Wallet</div>
                    <input type="number" class="input-field" id="endUber" placeholder="$0">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('endJourneyModal')">Cancelar</button>
                <button class="btn btn-success" onclick="previewEndJourney()">Ver Resumen</button>
            </div>
        </div>
    </div>

    <!-- Confirm End Journey Modal -->
    <div id="confirmEndModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚úÖ Resumen del D√≠a</h3>
                <button class="close-btn" onclick="closeModal('confirmEndModal')">&times;</button>
            </div>

            <!-- Resumen de ingresos por billetera -->
            <div style="margin-bottom: 1rem;">
                <div style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; font-weight: 700;">Lo que ganaste hoy por billetera</div>
                <div id="previewIncomes" style="background: var(--bg-tertiary); border-radius: 12px; padding: 1rem;"></div>
            </div>

            <!-- Gastos -->
            <div style="margin-bottom: 1rem;">
                <div style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; font-weight: 700;">Gastos del d√≠a</div>
                <div id="previewExpenses" style="background: var(--bg-tertiary); border-radius: 12px; padding: 1rem;"></div>
            </div>

            <!-- Resultado final -->
            <div id="previewResult" style="background: rgba(74, 222, 128, 0.1); border: 2px solid var(--accent-green); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;"></div>

            <!-- Advertencia si algo no cierra -->
            <div id="previewWarning" style="display:none; background: rgba(248, 113, 113, 0.15); border: 2px solid var(--accent-red); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; font-size: 0.85rem; color: var(--accent-red);"></div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('confirmEndModal'); document.getElementById('endJourneyModal').classList.add('active');">‚úèÔ∏è Corregir</button>
                <button class="btn btn-success" onclick="endJourney()">Confirmar ‚úÖ</button>
            </div>
        </div>
    </div>

    <!-- Uber Counter Modal -->
    <div id="uberCounterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Actualizar Contador Uber</h3>
                <button class="close-btn" onclick="closeModal('uberCounterModal')">&times;</button>
            </div>
            <div class="input-group">
                <label class="input-label">Importe Actual en Uber</label>
                <input type="number" class="input-field" id="uberCounterInput" placeholder="$0">
            </div>
            <button class="btn btn-primary" onclick="saveUberCounter()">Guardar</button>
        </div>
    </div>

    <!-- Tabla Screen -->
    <div id="tablaScreen" class="screen">
        <div class="container" style="padding-bottom: 5rem;">
            <h1 style="text-align:center; font-size:1rem; color:var(--accent-orange); text-transform:uppercase; letter-spacing:2px; margin: 1rem 0 0.25rem;">üèçÔ∏è Tabla de Aceptaci√≥n</h1>
            <p style="text-align:center; font-size:0.75rem; color:var(--text-secondary); margin-bottom:1rem;">La Rioja ¬∑ Costo real $52/km</p>

            <div style="background:#ffffff; border-radius:12px; overflow:hidden; border:2px solid #1e293b;">
                <div style="padding:0.65rem 1rem; background:#1e293b; border-bottom:2px solid #1e293b;">
                    <div style="font-size:0.85rem; font-weight:700; color:#ffffff; text-transform:uppercase; letter-spacing:1px;">Tabla de Aceptaci√≥n de Viajes</div>
                    <div style="font-size:0.65rem; color:#94a3b8; margin-top:0.2rem;">Calibrada para La Rioja ¬∑ $150/km</div>
                </div>
                <table style="width:100%; border-collapse:collapse; font-family:'Courier New',monospace;">
                    <thead>
                        <tr style="background:#f1f5f9;">
                            <th style="padding:0.6rem 0.5rem; font-size:0.75rem; color:#1e293b; text-align:center; font-weight:800;">B√∫sq.</th>
                            <th style="padding:0.6rem 0.5rem; font-size:0.75rem; color:#dc2626; text-align:center; font-weight:800;">Rechazar</th>
                            <th style="padding:0.6rem 0.5rem; font-size:0.75rem; color:#d97706; text-align:center; font-weight:800;">Zona Gris</th>
                            <th style="padding:0.6rem 0.5rem; font-size:0.75rem; color:#16a34a; text-align:center; font-weight:800;">Aceptar</th>
                        </tr>
                    </thead>
                    <tbody id="tablaBody">
                        <tr style="border-bottom:1px solid #e2e8f0"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;font-size:0.92rem;">0.5</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$875</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1075</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$1275</td></tr>
                        <tr style="border-bottom:1px solid #e2e8f0;background:#f8fafc"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">1.0</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$950</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1150</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$1350</td></tr>
                        <tr style="border-bottom:1px solid #e2e8f0"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">1.5</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$1025</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1225</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$1425</td></tr>
                        <tr style="border-bottom:1px solid #e2e8f0;background:#f8fafc"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">2.0</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$1100</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1300</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$1500</td></tr>
                        <tr style="border-bottom:1px solid #e2e8f0"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">2.5</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$1175</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1375</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$1575</td></tr>
                        <tr style="border-bottom:1px solid #e2e8f0;background:#f8fafc"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">3.0</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$1250</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1450</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$1650</td></tr>
                        <tr style="border-bottom:1px solid #e2e8f0"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">3.5</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$1325</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1525</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$1725</td></tr>
                        <tr style="border-bottom:1px solid #e2e8f0;background:#f8fafc"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">4.0</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$1400</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1600</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$1800</td></tr>
                        <tr style="border-bottom:1px solid #e2e8f0"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">4.5</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$1475</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1675</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$1875</td></tr>
                        <tr style="border-bottom:1px solid #e2e8f0;background:#f8fafc"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">5.0</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$1550</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1750</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$1950</td></tr>
                        <tr style="border-bottom:1px solid #e2e8f0"><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">5.5</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$1625</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1825</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$2025</td></tr>
                        <tr><td style="padding:0.55rem 0.5rem;text-align:center;color:#1e293b;font-weight:800;font-size:1.05rem;">6.0</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#dc2626;font-weight:700;font-size:1.05rem;">&lt;$1700</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#d97706;font-weight:700;font-size:1.05rem;">~$1900</td><td style="padding:0.55rem 0.5rem;text-align:center;color:#16a34a;font-weight:800;font-size:1.05rem;">&gt;$2100</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Leyenda -->
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:0.5rem; margin-top:0.75rem;">
                <div style="display:flex;align-items:center;gap:0.4rem;background:#ffffff;padding:0.5rem;border-radius:8px;justify-content:center;font-size:0.72rem;color:#dc2626;font-weight:700;border:1px solid #e2e8f0;"><div style="width:9px;height:9px;border-radius:50%;background:#dc2626;flex-shrink:0;"></div>Rechazar</div>
                <div style="display:flex;align-items:center;gap:0.4rem;background:#ffffff;padding:0.5rem;border-radius:8px;justify-content:center;font-size:0.72rem;color:#d97706;font-weight:700;border:1px solid #e2e8f0;"><div style="width:9px;height:9px;border-radius:50%;background:#d97706;flex-shrink:0;"></div>Zona Gris</div>
                <div style="display:flex;align-items:center;gap:0.4rem;background:#ffffff;padding:0.5rem;border-radius:8px;justify-content:center;font-size:0.72rem;color:#16a34a;font-weight:700;border:1px solid #e2e8f0;"><div style="width:9px;height:9px;border-radius:50%;background:#16a34a;flex-shrink:0;"></div>Aceptar</div>
            </div>

            <!-- Regla anti-penalizaci√≥n -->
            <div style="margin-top:0.75rem; background:#ffffff; border-radius:12px; padding:0.85rem 1rem; border-left:4px solid #d97706; border-top:1px solid #e2e8f0; border-right:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0;">
                <div style="font-size:0.75rem; color:#d97706; text-transform:uppercase; letter-spacing:1px; font-weight:800; margin-bottom:0.4rem;">‚ö†Ô∏è Regla anti-penalizaci√≥n</div>
                <p style="font-size:0.78rem; color:#334155; line-height:1.6;">Nunca rechaces <strong style="color:#1e293b;">m√°s de 2 viajes seguidos</strong>. Si ya rechazaste 2, acept√° el siguiente sin importar el valor.</p>
            </div>
        </div>
    </div>

    <!-- Mantenimiento Screen -->
    <div id="mantenimientoScreen" class="screen">
        <div class="container" style="padding-bottom: 5rem;">
            <div style="display:flex; align-items:center; gap:0.75rem; margin: 1rem 0 1.25rem;">
                <button onclick="switchScreen('dashboard')" style="background:none;border:none;color:var(--text-secondary);font-size:1.3rem;cursor:pointer;">‚Äπ</button>
                <h1 style="font-size:1rem; color:var(--accent-orange); text-transform:uppercase; letter-spacing:2px; margin:0;">üîß Mantenimiento</h1>
            </div>

            <!-- KM actual -->
            <div class="card" style="margin-bottom:1rem;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:0.75rem; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.5px;">KM Actual (√∫ltimo inicio de jornada)</div>
                        <div style="font-size:1.4rem; font-weight:800; color:var(--accent-green); font-family:'JetBrains Mono',monospace;" id="currentKmDisplay">‚Äî</div>
                    </div>
                </div>
            </div>

            <!-- Lista de tareas -->
            <div id="maintenanceList"></div>

            <!-- Modal registro tarea -->
            <div id="maintenanceModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="maintenanceModalTitle">Registrar Tarea</h3>
                        <button class="close-btn" onclick="closeModal('maintenanceModal')">&times;</button>
                    </div>
                    <div class="input-group">
                        <label class="input-label">KM al realizar la tarea</label>
                        <input type="number" class="input-field" id="maintenanceKmInput" placeholder="Ej: 5800">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Notas (opcional)</label>
                        <input type="text" class="input-field" id="maintenanceNotesInput" placeholder="Ej: Cambi√© por aceite Motul 10W40">
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeModal('maintenanceModal')">Cancelar</button>
                        <button class="btn btn-success" onclick="saveMaintenanceTask()">Registrar ‚úÖ</button>
                    </div>
                </div>
            </div>

            <!-- Modal actualizar KM -->
            <div id="updateKmModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">KM Actual del Od√≥metro</h3>
                        <button class="close-btn" onclick="closeModal('updateKmModal')">&times;</button>
                    </div>
                    <div class="input-group">
                        <label class="input-label">KM actual</label>
                        <input type="number" class="input-field" id="currentKmInput" placeholder="Ej: 5314">
                    </div>
                    <button class="btn btn-success" onclick="saveCurrentKm()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchScreen('dashboard')">
            <div class="nav-icon">üìä</div>
            <div>Dashboard</div>
        </button>
        <button class="nav-btn" onclick="switchScreen('journey')" id="journeyNavBtn">
            <div class="nav-icon">üèçÔ∏è</div>
            <div>Jornada</div>
        </button>
        <button class="nav-btn" onclick="switchScreen('history')">
            <div class="nav-icon">üìú</div>
            <div>Historial</div>
        </button>
        <button class="nav-btn" onclick="switchScreen('tabla')">
            <div class="nav-icon">üìã</div>
            <div>Viajes</div>
        </button>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        let activeJourney = null;
        let journeys = [];
        let currentExpenseType = null;
        let currentPaymentMethod = null;
        let journeyTimer = null;

        // Inicializar la aplicaci√≥n
        function init() {
            loadData();
            loadMaintenanceData();
            updateDashboard();
            updateHistory();
            updateMaintenancePreview();
            checkActiveJourney();
            
            // Registrar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
            }
        }

        // Cargar datos del localStorage
        function loadData() {
            const savedJourneys = localStorage.getItem('journeys');
            const savedActiveJourney = localStorage.getItem('activeJourney');
            
            if (savedJourneys) {
                journeys = JSON.parse(savedJourneys);
            }
            
            if (savedActiveJourney) {
                activeJourney = JSON.parse(savedActiveJourney);
                startTimer();
            }
        }

        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('journeys', JSON.stringify(journeys));
            if (activeJourney) {
                localStorage.setItem('activeJourney', JSON.stringify(activeJourney));
            } else {
                localStorage.removeItem('activeJourney');
            }
        }

        // Verificar jornada activa
        function checkActiveJourney() {
            if (activeJourney) {
                document.getElementById('activeJourneyCard').style.display = 'block';
                document.getElementById('noActiveJourneyCard').style.display = 'none';
                document.getElementById('journeyNavBtn').classList.add('active');
                updateJourneyDisplay();
            } else {
                document.getElementById('activeJourneyCard').style.display = 'none';
                document.getElementById('noActiveJourneyCard').style.display = 'block';
                document.getElementById('journeyNavBtn').classList.remove('active');
            }
        }

        // Cambiar de pantalla
        function switchScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            if (screen === 'dashboard') {
                document.getElementById('dashboardScreen').classList.add('active');
                document.querySelector('.nav-btn').classList.add('active');
                updateDashboard();
            } else if (screen === 'journey') {
                if (activeJourney) {
                    document.getElementById('journeyScreen').classList.add('active');
                    document.getElementById('journeyNavBtn').classList.add('active');
                    updateJourneyDisplay();
                } else {
                    alert('No hay jornada activa');
                    switchScreen('dashboard');
                }
            } else if (screen === 'history') {
                document.getElementById('historyScreen').classList.add('active');
                document.querySelectorAll('.nav-btn')[2].classList.add('active');
                updateHistory();
            } else if (screen === 'tabla') {
                document.getElementById('tablaScreen').classList.add('active');
                document.querySelectorAll('.nav-btn')[3].classList.add('active');
            } else if (screen === 'mantenimiento') {
                document.getElementById('mantenimientoScreen').classList.add('active');
                renderMaintenanceList();
            }
        }

        // Ir a jornada actual
        function goToJourney() {
            switchScreen('journey');
        }

        // Mostrar modal de inicio de jornada
        function showStartJourneyModal() {
            // Pre-completar KM con el endKm de la √∫ltima jornada
            if (journeys.length > 0) {
                const lastJourney = journeys[journeys.length - 1];
                if (lastJourney.endKm) {
                    document.getElementById('startKm').value = lastJourney.endKm;
                }
            }
            document.getElementById('startJourneyModal').classList.add('active');
        }

        // Iniciar jornada
        function startJourney() {
            const kmStart = parseFloat(document.getElementById('startKm').value) || 0;
            const startNX = parseFloat(document.getElementById('startNX').value) || 0;
            const startMP = parseFloat(document.getElementById('startMP').value) || 0;
            const startCash = parseFloat(document.getElementById('startCash').value) || 0;
            const startUber = parseFloat(document.getElementById('startUber').value) || 0;

            activeJourney = {
                id: Date.now(),
                startTime: new Date().toISOString(),
                startKm: kmStart,
                startWallets: {
                    nx: startNX,
                    mp: startMP,
                    cash: startCash,
                    uber: startUber
                },
                expenses: [],
                incomes: [],
                uberCounter: 0
            };

            saveData();
            closeModal('startJourneyModal');
            checkActiveJourney();
            switchScreen('journey');
            startTimer();
        }

        // Timer de jornada
        function startTimer() {
            if (journeyTimer) clearInterval(journeyTimer);
            
            journeyTimer = setInterval(() => {
                if (!activeJourney) return;
                
                const start = new Date(activeJourney.startTime);
                const now = new Date();
                const diff = now - start;
                
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                document.getElementById('journeyTimer').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        // Actualizar contador Uber
        function updateUberCounter() {
            document.getElementById('uberCounterInput').value = activeJourney.uberCounter || 0;
            document.getElementById('uberCounterModal').classList.add('active');
        }

        function saveUberCounter() {
            const value = parseFloat(document.getElementById('uberCounterInput').value) || 0;
            activeJourney.uberCounter = value;
            saveData();
            updateJourneyDisplay();
            closeModal('uberCounterModal');
        }

        // Mostrar modal de gastos
        function showExpenseModal(type) {
            currentExpenseType = type;
            currentPaymentMethod = null;
            
            const titles = {
                fuel: 'Agregar Combustible',
                moto: 'Gasto de Moto',
                personal: 'Gasto Personal'
            };
            
            document.getElementById('expenseModalTitle').textContent = titles[type];
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseConcept').value = '';
            document.getElementById('expenseCash').value = '0';
            document.getElementById('expenseTransfer').value = '0';
            document.getElementById('expenseMP').value = '0';
            document.getElementById('paymentWarning').style.display = 'none';
            
            // Ocultar concepto para combustible
            if (type === 'fuel') {
                document.getElementById('conceptGroup').style.display = 'none';
            } else {
                document.getElementById('conceptGroup').style.display = 'block';
            }
            
            document.getElementById('expenseModal').classList.add('active');
        }

        // Actualizar distribuci√≥n de pagos
        function updatePaymentDistribution(changedField) {
            const totalAmount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const cashInput = document.getElementById('expenseCash');
            const transferInput = document.getElementById('expenseTransfer');
            const mpInput = document.getElementById('expenseMP');
            const warningDiv = document.getElementById('paymentWarning');
            
            let cash = parseFloat(cashInput.value) || 0;
            let transfer = parseFloat(transferInput.value) || 0;
            let mp = parseFloat(mpInput.value) || 0;
            
            // Si se cambi√≥ un campo, ajustar el otro autom√°ticamente (solo entre cash y transfer cuando mp=0)
            if (changedField === 'cash' && mp === 0) {
                transfer = Math.max(0, totalAmount - cash);
                transferInput.value = transfer;
            } else if (changedField === 'transfer' && mp === 0) {
                cash = Math.max(0, totalAmount - transfer);
                cashInput.value = cash;
            } else if (changedField === 'mp') {
                // Si se ingres√≥ MP, limpiar los otros si sumaban el total
                const remaining = Math.max(0, totalAmount - mp);
                if (cash + transfer > remaining) {
                    cashInput.value = 0;
                    transferInput.value = 0;
                    cash = 0;
                    transfer = 0;
                }
            }
            
            // Validar que la suma coincida
            const sum = cash + transfer + mp;
            if (totalAmount > 0 && Math.abs(sum - totalAmount) > 0.01) {
                warningDiv.textContent = `‚ö†Ô∏è La suma (${formatCurrency(sum)}) no coincide con el total (${formatCurrency(totalAmount)})`;
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        }

        // Agregar gasto
        function addExpense() {
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const concept = document.getElementById('expenseConcept').value;
            const cash = parseFloat(document.getElementById('expenseCash').value) || 0;
            const transfer = parseFloat(document.getElementById('expenseTransfer').value) || 0;
            const mp = parseFloat(document.getElementById('expenseMP').value) || 0;
            
            if (!amount || amount <= 0) {
                alert('Ingresa un monto v√°lido');
                return;
            }
            
            if (cash === 0 && transfer === 0 && mp === 0) {
                alert('Debes especificar c√≥mo se pag√≥ (efectivo, NX y/o Mercado Pago)');
                return;
            }
            
            if (Math.abs((cash + transfer + mp) - amount) > 0.01) {
                alert('La suma de los m√©todos de pago debe ser igual al monto total');
                return;
            }
            
            if (currentExpenseType !== 'fuel' && !concept) {
                alert('Ingresa un concepto');
                return;
            }
            
            const expense = {
                id: Date.now(),
                type: currentExpenseType,
                amount: amount,
                concept: currentExpenseType === 'fuel' ? 'Combustible' : concept,
                paymentCash: cash,
                paymentTransfer: transfer,
                paymentMP: mp,
                timestamp: new Date().toISOString()
            };
            
            activeJourney.expenses.push(expense);
            saveData();
            updateJourneyDisplay();
            closeModal('expenseModal');
        }

        // Mostrar modal de ingresos
        function showIncomeModal() {
            document.getElementById('incomeNX').value = 0;
            document.getElementById('incomeMP').value = 0;
            document.getElementById('incomeCash').value = 0;
            document.getElementById('incomeUber').value = 0;
            document.getElementById('incomeModal').classList.add('active');
        }

        // Agregar ingreso
        function addIncome() {
            const nx = parseFloat(document.getElementById('incomeNX').value) || 0;
            const mp = parseFloat(document.getElementById('incomeMP').value) || 0;
            const cash = parseFloat(document.getElementById('incomeCash').value) || 0;
            const uber = parseFloat(document.getElementById('incomeUber').value) || 0;
            
            if (nx === 0 && mp === 0 && cash === 0 && uber === 0) {
                alert('Ingresa al menos un incremento');
                return;
            }
            
            const income = {
                id: Date.now(),
                nx: nx,
                mp: mp,
                cash: cash,
                uber: uber,
                timestamp: new Date().toISOString()
            };
            
            activeJourney.incomes.push(income);
            saveData();
            updateJourneyDisplay();
            closeModal('incomeModal');
        }

        // Actualizar display de jornada
        function updateJourneyDisplay() {
            if (!activeJourney) return;
            
            // Actualizar KM
            document.getElementById('kmStart').textContent = activeJourney.startKm;
            
            // Calcular totales
            const totalIncome = activeJourney.incomes.reduce((sum, inc) => 
                sum + inc.nx + (inc.mp || 0) + inc.cash + inc.uber, 0);
            
            const fuelExpenses = activeJourney.expenses
                .filter(e => e.type === 'fuel')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const motoExpenses = activeJourney.expenses
                .filter(e => e.type === 'moto')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const personalExpenses = activeJourney.expenses
                .filter(e => e.type === 'personal')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const bruta = totalIncome;
            const operativa = bruta - fuelExpenses - motoExpenses;
            const neta = operativa - personalExpenses;
            
            document.getElementById('brutaValue').textContent = formatCurrency(bruta);
            document.getElementById('operativaValue').textContent = formatCurrency(operativa);
            document.getElementById('netaValue').textContent = formatCurrency(neta);
            
            // Contador Uber
            document.getElementById('uberCounter').textContent = formatCurrency(activeJourney.uberCounter || 0);
            
            // Calcular saldo actual de Uber Wallet
            const uberIncomeTotal = activeJourney.incomes.reduce((sum, inc) => sum + inc.uber, 0);
            const currentUberWallet = (activeJourney.startWallets.uber || 0) + uberIncomeTotal;
            document.getElementById('currentUberWallet').textContent = formatCurrency(currentUberWallet);

            // Calcular saldo actual de Mercado Pago
            const mpIncomeTotal = activeJourney.incomes.reduce((sum, inc) => sum + (inc.mp || 0), 0);
            const mpExpensesTotal = activeJourney.expenses.reduce((sum, e) => sum + (e.paymentMP || 0), 0);
            const currentMP = (activeJourney.startWallets.mp || 0) + mpIncomeTotal - mpExpensesTotal;
            document.getElementById('currentMP').textContent = formatCurrency(currentMP);
            
            // Mostrar gastos
            const expenseList = document.getElementById('expenseList');
            if (activeJourney.expenses.length === 0) {
                expenseList.innerHTML = '';
            } else {
                expenseList.innerHTML = '<div style="margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 700; font-size: 0.9rem;">Gastos Registrados:</div>' +
                    activeJourney.expenses.map(exp => {
                        const typeClass = exp.type;
                        const typeEmoji = exp.type === 'fuel' ? '‚õΩ' : exp.type === 'moto' ? 'üîß' : 'üçî';
                        
                        // Determinar m√©todo de pago
                        let paymentParts = [];
                        if (exp.paymentCash > 0) paymentParts.push(`üíµ ${formatCurrency(exp.paymentCash)}`);
                        if (exp.paymentTransfer > 0) paymentParts.push(`üí≥ ${formatCurrency(exp.paymentTransfer)}`);
                        if (exp.paymentMP > 0) paymentParts.push(`üü¶ ${formatCurrency(exp.paymentMP)}`);
                        let paymentText = paymentParts.length > 0 ? paymentParts.join(' + ') : 
                            (exp.paymentMethod === 'efectivo' ? 'üíµ Efectivo' : 'üí≥ Transferencia');
                        
                        return `
                            <div class="expense-item">
                                <div>
                                    <div>${typeEmoji} ${exp.concept}</div>
                                    <div class="expense-concept">${paymentText}</div>
                                </div>
                                <div class="expense-amount ${typeClass}">-${formatCurrency(exp.amount)}</div>
                            </div>
                        `;
                    }).join('');
            }
        }

        // Mostrar modal de fin de jornada
        function showEndJourneyModal() {
            document.getElementById('endKm').value = '';
            document.getElementById('endUberCounter').value = activeJourney?.uberCounter || '';
            document.getElementById('endMP').value = '';
            document.getElementById('endNX').value = '';
            document.getElementById('endCash').value = '';
            document.getElementById('endUber').value = '';
            document.getElementById('endJourneyModal').classList.add('active');
        }

        // ===== MANTENIMIENTO =====
        const MAINTENANCE_TASKS = [
            { id: 'aceite',     name: 'Cambio de aceite + filtro',         interval: 3000,  canDoIt: false, urgent: false, notes: 'Pr√≥ximo: ~5,800 km' },
            { id: 'cadena',     name: 'Limpiar y lubricar cadena',          interval: 500,   canDoIt: true,  urgent: false, notes: 'Cada ~4 d√≠as de trabajo' },
            { id: 'tension',    name: 'Tensi√≥n de cadena',                  interval: 500,   canDoIt: true,  urgent: false, notes: 'Holgura ideal: 20-30mm' },
            { id: 'frenos',     name: 'Inspecci√≥n pastillas/zapatas freno', interval: 4000,  canDoIt: false, urgent: false, notes: 'Reemplazo en concesionario' },
            { id: 'frenabs',    name: 'Cable freno ABS (sujeci√≥n)',         interval: 0,     canDoIt: false, urgent: true,  notes: '‚ö†Ô∏è URGENTE ‚Äî llevar al concesionario' },
            { id: 'filtroaire', name: 'Limpieza filtro de aire',            interval: 4000,  canDoIt: true,  urgent: false, notes: 'M√°s seguido en zonas polvorientas' },
            { id: 'neumaticos', name: 'Presi√≥n y estado neum√°ticos',        interval: 500,   canDoIt: true,  urgent: false, notes: 'Verificar semanalmente' },
            { id: 'bateria',    name: 'Inspecci√≥n bater√≠a',                 interval: 8000,  canDoIt: true,  urgent: false, notes: 'Visual ‚Äî buscar corrosi√≥n' },
            { id: 'caballete',  name: 'Limpieza y lubricaci√≥n caballete',   interval: 4000,  canDoIt: true,  urgent: false, notes: '' },
            { id: 'valvulas',   name: 'Regulaci√≥n de v√°lvulas',             interval: 8000,  canDoIt: false, urgent: false, notes: '0.08mm admisi√≥n / 0.12mm escape' },
            { id: 'embrague',   name: 'Ajuste cable de embrague',           interval: 0,     canDoIt: true,  urgent: false, notes: 'Si nota dureza o juego excesivo' },
            { id: 'calor',      name: 'Consultar recalentamiento motor',    interval: 0,     canDoIt: false, urgent: true,  notes: '‚ö†Ô∏è Consultar en service del 06/03' },
            { id: 'liqufrenos', name: 'Cambio l√≠quido de frenos',           interval: 0,     canDoIt: false, urgent: false, notes: 'Cada 2 a√±os ‚Äî DOT 3 o DOT 4' },
        ];

        let maintenanceData = {};
        let currentOdometerKm = 0;
        let currentMaintenanceTaskId = null;

        function loadMaintenanceData() {
            const saved = localStorage.getItem('maintenanceData');
            if (saved) maintenanceData = JSON.parse(saved);
            const savedKm = localStorage.getItem('currentOdometerKm');
            if (savedKm) currentOdometerKm = parseInt(savedKm);
        }

        function saveMaintenanceData() {
            localStorage.setItem('maintenanceData', JSON.stringify(maintenanceData));
            localStorage.setItem('currentOdometerKm', currentOdometerKm);
        }

        function updateCurrentKm() {
            document.getElementById('currentKmInput').value = currentOdometerKm || '';
            document.getElementById('updateKmModal').classList.add('active');
        }

        function saveCurrentKm() {
            const km = parseInt(document.getElementById('currentKmInput').value);
            if (km > 0) {
                currentOdometerKm = km;
                saveMaintenanceData();
                closeModal('updateKmModal');
                renderMaintenanceList();
                updateMaintenancePreview();
            }
        }

        function getLatestOdometerKm() {
            // Toma el KM de inicio de la √∫ltima jornada registrada
            if (journeys.length > 0) {
                const last = journeys[journeys.length - 1];
                return last.endKm || last.startKm || 0;
            }
            return currentOdometerKm || 0;
        }

        function renderMaintenanceList() {
            const kmActual = getLatestOdometerKm();
            document.getElementById('currentKmDisplay').textContent = kmActual ? `${kmActual.toLocaleString()} km` : '‚Äî Sin jornadas registradas';

            const container = document.getElementById('maintenanceList');
            let html = '';

            MAINTENANCE_TASKS.forEach(task => {
                const record = maintenanceData[task.id];
                const lastKm = record ? record.km : null;
                const lastDate = record ? record.date : null;

                let statusColor = 'var(--accent-green)';
                let statusText = 'Al d√≠a ‚úÖ';
                let statusBg = 'rgba(74, 222, 128, 0.08)';
                let kmLeft = null;

                if (task.urgent) {
                    statusColor = 'var(--accent-red)';
                    statusText = '‚ö†Ô∏è URGENTE';
                    statusBg = 'rgba(248, 113, 113, 0.12)';
                } else if (task.interval === 0) {
                    statusColor = 'var(--accent-blue)';
                    statusText = 'Seg√∫n necesidad';
                    statusBg = 'rgba(96, 165, 250, 0.08)';
                } else if (lastKm && kmActual) {
                    kmLeft = task.interval - (kmActual - lastKm);
                    if (kmLeft <= 0) {
                        statusColor = 'var(--accent-red)';
                        statusText = `Vencido (${Math.abs(kmLeft).toLocaleString()} km pasados) ‚ùå`;
                        statusBg = 'rgba(248, 113, 113, 0.12)';
                    } else if (kmLeft <= task.interval * 0.2) {
                        statusColor = 'var(--accent-orange)';
                        statusText = `Pronto: ${kmLeft.toLocaleString()} km ‚ö†Ô∏è`;
                        statusBg = 'rgba(251, 146, 60, 0.1)';
                    } else {
                        statusText = `Faltan ${kmLeft.toLocaleString()} km ‚úÖ`;
                    }
                } else if (!lastKm) {
                    statusColor = 'var(--text-secondary)';
                    statusText = 'Sin registro';
                    statusBg = 'var(--bg-tertiary)';
                }

                const canBadge = task.canDoIt
                    ? `<span style="font-size:0.6rem;background:rgba(74,222,128,0.15);color:var(--accent-green);padding:0.15rem 0.4rem;border-radius:4px;font-weight:700;">Vos pod√©s</span>`
                    : `<span style="font-size:0.6rem;background:rgba(96,165,250,0.15);color:var(--accent-blue);padding:0.15rem 0.4rem;border-radius:4px;font-weight:700;">Concesionario</span>`;

                const lastInfo = lastKm
                    ? `√öltima vez: ${lastKm.toLocaleString()} km${lastDate ? ' ¬∑ ' + lastDate : ''}`
                    : 'Sin registro previo';

                html += `
                <div style="background:${statusBg};border-radius:12px;padding:0.85rem 1rem;margin-bottom:0.65rem;border-left:4px solid ${statusColor};">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.35rem;">
                        <div style="font-size:0.88rem;font-weight:700;color:var(--text-primary);flex:1;padding-right:0.5rem;">${task.name}</div>
                        ${canBadge}
                    </div>
                    <div style="font-size:0.78rem;font-weight:700;color:${statusColor};margin-bottom:0.25rem;">${statusText}</div>
                    <div style="font-size:0.72rem;color:var(--text-secondary);margin-bottom:0.25rem;">${lastInfo}</div>
                    ${task.notes ? `<div style="font-size:0.7rem;color:var(--text-secondary);font-style:italic;">${task.notes}</div>` : ''}
                    ${task.interval > 0 || task.urgent ? `<button onclick="openMaintenanceModal('${task.id}')" style="margin-top:0.5rem;background:none;border:1px solid var(--border);color:var(--text-secondary);padding:0.3rem 0.6rem;border-radius:6px;font-size:0.72rem;cursor:pointer;">‚úèÔ∏è Registrar tarea</button>` : ''}
                </div>`;
            });

            container.innerHTML = html;
        }

        function openMaintenanceModal(taskId) {
            currentMaintenanceTaskId = taskId;
            const task = MAINTENANCE_TASKS.find(t => t.id === taskId);
            document.getElementById('maintenanceModalTitle').textContent = task.name;
            document.getElementById('maintenanceKmInput').value = getLatestOdometerKm() || '';
            document.getElementById('maintenanceNotesInput').value = '';
            document.getElementById('maintenanceModal').classList.add('active');
        }

        function saveMaintenanceTask() {
            const km = parseInt(document.getElementById('maintenanceKmInput').value);
            const notes = document.getElementById('maintenanceNotesInput').value;
            if (!km) return;

            const now = new Date();
            const date = `${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()}`;

            maintenanceData[currentMaintenanceTaskId] = { km, date, notes };
            saveMaintenanceData();
            closeModal('maintenanceModal');
            renderMaintenanceList();
            updateMaintenancePreview();
        }

        function updateMaintenancePreview() {
            const preview = document.getElementById('nextMaintenancePreview');
            if (!preview) return;

            const urgent = MAINTENANCE_TASKS.filter(t => t.urgent);
            const overdue = MAINTENANCE_TASKS.filter(t => {
                if (t.interval === 0 || t.urgent) return false;
                const record = maintenanceData[t.id];
                if (!record || !currentOdometerKm) return false;
                return (currentOdometerKm - record.km) >= t.interval;
            });

            if (urgent.length > 0) {
                preview.style.color = 'var(--accent-red)';
                preview.textContent = `‚ö†Ô∏è ${urgent.length} tarea(s) urgente(s) pendiente(s)`;
            } else if (overdue.length > 0) {
                preview.style.color = 'var(--accent-orange)';
                preview.textContent = `‚ö†Ô∏è ${overdue.length} tarea(s) vencida(s)`;
            } else {
                preview.style.color = 'var(--accent-green)';
                preview.textContent = '‚úÖ Todo al d√≠a';
            }
        }
        // ===== FIN MANTENIMIENTO =====
        let previewData = null;

        // Preview antes de finalizar
        function previewEndJourney() {
            const endKm    = parseFloat(document.getElementById('endKm').value) || 0;
            const endNX    = parseFloat(document.getElementById('endNX').value) || 0;
            const endMP    = parseFloat(document.getElementById('endMP').value) || 0;
            const endCash  = parseFloat(document.getElementById('endCash').value) || 0;
            const endUber  = parseFloat(document.getElementById('endUber').value) || 0;
            const endUberCounter = parseFloat(document.getElementById('endUberCounter').value) || activeJourney.uberCounter || 0;

            // Guardar para usar en endJourney
            previewData = { endKm, endNX, endMP, endCash, endUber, endUberCounter };

            const start = activeJourney.startWallets;

            const gastoNX   = activeJourney.expenses.reduce((s, e) => s + (e.paymentTransfer || 0), 0);
            const gastoMP   = activeJourney.expenses.reduce((s, e) => s + (e.paymentMP || 0), 0);
            const gastoCash = activeJourney.expenses.reduce((s, e) => s + (e.paymentCash || 0), 0);

            const incNX   = (endNX   - (start.nx   || 0)) + gastoNX;
            const incMP   = (endMP   - (start.mp   || 0)) + gastoMP;
            const incCash = (endCash - (start.cash || 0)) + gastoCash;
            const incUber = (endUber - (start.uber || 0));

            const fuel     = activeJourney.expenses.filter(e => e.type === 'fuel').reduce((s, e) => s + e.amount, 0);
            const moto     = activeJourney.expenses.filter(e => e.type === 'moto').reduce((s, e) => s + e.amount, 0);
            const personal = activeJourney.expenses.filter(e => e.type === 'personal').reduce((s, e) => s + e.amount, 0);
            const bruta    = Math.max(0, incNX) + Math.max(0, incMP) + Math.max(0, incCash) + Math.max(0, incUber);

            // Mostrar ingresos por billetera
            const rowStyle = 'display:flex; justify-content:space-between; margin-bottom:0.5rem; font-size:0.9rem;';
            let incomesHTML = '';
            const wallets = [
                { label: 'üí≥ Naranja NX', val: incNX },
                { label: 'üü¶ Mercado Pago', val: incMP },
                { label: 'üíµ Efectivo', val: incCash },
                { label: 'üü£ Uber Wallet', val: incUber }
            ];
            wallets.forEach(w => {
                const color = w.val < 0 ? 'color:var(--accent-red)' : 'color:var(--accent-green)';
                incomesHTML += `<div style="${rowStyle}"><span>${w.label}</span><span style="font-family:monospace;font-weight:700;${color}">${w.val >= 0 ? '+' : ''}${formatCurrency(w.val)}</span></div>`;
            });
            document.getElementById('previewIncomes').innerHTML = incomesHTML;

            // Gastos
            let expHTML = '';
            if (fuel > 0)     expHTML += `<div style="${rowStyle}"><span>‚õΩ Combustible</span><span style="font-family:monospace;color:var(--accent-orange)">-${formatCurrency(fuel)}</span></div>`;
            if (moto > 0)     expHTML += `<div style="${rowStyle}"><span>üîß Gastos Moto</span><span style="font-family:monospace;color:var(--accent-blue)">-${formatCurrency(moto)}</span></div>`;
            if (personal > 0) expHTML += `<div style="${rowStyle}"><span>üçî Gastos Personales</span><span style="font-family:monospace;color:var(--accent-red)">-${formatCurrency(personal)}</span></div>`;
            if (!expHTML)     expHTML = '<div style="color:var(--text-secondary);font-size:0.85rem;">Sin gastos registrados</div>';
            document.getElementById('previewExpenses').innerHTML = expHTML;

            // Resultado
            const neta = bruta - fuel - moto - personal;
            const km = endKm - activeJourney.startKm;
            document.getElementById('previewResult').innerHTML = `
                <div style="${rowStyle} font-size:1rem;"><span style="font-weight:700;">üí∞ Bruta</span><span style="font-family:monospace;font-weight:700;color:var(--accent-green)">${formatCurrency(bruta)}</span></div>
                <div style="${rowStyle}"><span>Operativa</span><span style="font-family:monospace;font-weight:700;color:var(--accent-green)">${formatCurrency(bruta - fuel - moto)}</span></div>
                <div style="display:flex;justify-content:space-between;padding-top:0.5rem;border-top:1px solid var(--accent-green);font-size:1.1rem;"><span style="font-weight:700;">üèÅ Neta</span><span style="font-family:monospace;font-weight:800;color:var(--accent-green)">${formatCurrency(neta)}</span></div>
                <div style="margin-top:0.5rem;font-size:0.8rem;color:var(--text-secondary);">KM recorridos: ${km} | Contador Uber: ${formatCurrency(parseFloat(document.getElementById('endUberCounter').value) || 0)}</div>
            `;

            // Advertencias
            const warnings = [];
            if (incNX < -5000)   warnings.push(`‚ö†Ô∏è NX baj√≥ ${formatCurrency(Math.abs(incNX))} ‚Äî ¬øcorrecto?`);
            if (incMP < -5000)   warnings.push(`‚ö†Ô∏è MP baj√≥ ${formatCurrency(Math.abs(incMP))} ‚Äî ¬øcorrecto?`);
            if (incCash < -5000) warnings.push(`‚ö†Ô∏è Efectivo baj√≥ ${formatCurrency(Math.abs(incCash))} ‚Äî ¬øpusiste el saldo TOTAL o solo lo nuevo?`);
            if (incUber < 0)     warnings.push(`‚ÑπÔ∏è UW baj√≥ ${formatCurrency(Math.abs(incUber))} ‚Äî normal si Uber vaci√≥ tu wallet (se deposita el lunes en MP)`);
            if (bruta === 0)     warnings.push(`‚ö†Ô∏è La recaudaci√≥n calculada es $0 ‚Äî revis√° los saldos finales`);

            const warnDiv = document.getElementById('previewWarning');
            if (warnings.length > 0) {
                warnDiv.innerHTML = warnings.join('<br>');
                warnDiv.style.display = 'block';
            } else {
                warnDiv.style.display = 'none';
            }

            closeModal('endJourneyModal');
            document.getElementById('confirmEndModal').classList.add('active');
        }

        // Finalizar jornada
        function endJourney() {
            // Si no hay previewData, intentar leer del formulario directamente
            if (!previewData) {
                previewData = {
                    endKm: parseFloat(document.getElementById('endKm').value) || 0,
                    endNX: parseFloat(document.getElementById('endNX').value) || 0,
                    endMP: parseFloat(document.getElementById('endMP').value) || 0,
                    endCash: parseFloat(document.getElementById('endCash').value) || 0,
                    endUber: parseFloat(document.getElementById('endUber').value) || 0,
                    endUberCounter: parseFloat(document.getElementById('endUberCounter').value) || activeJourney.uberCounter || 0
                };
            }
            const { endKm, endNX, endMP, endCash, endUber, endUberCounter } = previewData;

            activeJourney.endTime = new Date().toISOString();
            activeJourney.endKm = endKm;
            activeJourney.uberCounter = endUberCounter;
            activeJourney.endWallets = { nx: endNX, mp: endMP, cash: endCash, uber: endUber };

            // Gastos por tipo
            const fuelExpenses = activeJourney.expenses
                .filter(e => e.type === 'fuel').reduce((sum, e) => sum + e.amount, 0);
            const motoExpenses = activeJourney.expenses
                .filter(e => e.type === 'moto').reduce((sum, e) => sum + e.amount, 0);
            const personalExpenses = activeJourney.expenses
                .filter(e => e.type === 'personal').reduce((sum, e) => sum + e.amount, 0);

            // Gastos pagados por cada billetera
            const gastoNX   = activeJourney.expenses.reduce((sum, e) => sum + (e.paymentTransfer || 0), 0);
            const gastoMP   = activeJourney.expenses.reduce((sum, e) => sum + (e.paymentMP || 0), 0);
            const gastoCash = activeJourney.expenses.reduce((sum, e) => sum + (e.paymentCash || 0), 0);

            // Calcular ingresos autom√°ticamente desde diferencia de billeteras + gastos pagados
            const startWallets = activeJourney.startWallets;
            const incomeNX   = (endNX   - (startWallets.nx   || 0)) + gastoNX;
            const incomeMP   = (endMP   - (startWallets.mp   || 0)) + gastoMP;
            const incomeCash = (endCash - (startWallets.cash || 0)) + gastoCash;
            const incomeUber = (endUber - (startWallets.uber || 0));

            // Bruta = suma de todos los ingresos calculados (solo positivos)
            const bruta = Math.max(0, incomeNX) + Math.max(0, incomeMP) + Math.max(0, incomeCash) + Math.max(0, incomeUber);

            // Registrar ingreso calculado autom√°ticamente
            const autoIncome = {
                id: Date.now(),
                nx: Math.max(0, incomeNX),
                mp: Math.max(0, incomeMP),
                cash: Math.max(0, incomeCash),
                uber: Math.max(0, incomeUber),
                timestamp: new Date().toISOString(),
                auto: true
            };

            // Solo agregar si no hab√≠a ingresos manuales registrados
            if (activeJourney.incomes.length === 0) {
                activeJourney.incomes.push(autoIncome);
            }

            // Recalcular bruta final considerando ingresos manuales si los hay
            const totalIncome = activeJourney.incomes.reduce((sum, inc) =>
                sum + (inc.nx || 0) + (inc.mp || 0) + (inc.cash || 0) + (inc.uber || 0), 0);

            activeJourney.earnings = {
                bruta: totalIncome,
                operativa: totalIncome - fuelExpenses - motoExpenses,
                neta: totalIncome - fuelExpenses - motoExpenses - personalExpenses,
                fuel: fuelExpenses,
                moto: motoExpenses,
                personal: personalExpenses
            };

            activeJourney.kmTraveled = endKm - activeJourney.startKm;
            
            journeys.push(activeJourney);
            activeJourney = null;
            
            if (journeyTimer) {
                clearInterval(journeyTimer);
                journeyTimer = null;
            }
            
            saveData();
            closeModal('confirmEndModal');
            closeModal('endJourneyModal');
            previewData = null;
            checkActiveJourney();
            switchScreen('dashboard');
            updateDashboard();
        }

        // Actualizar dashboard
        function updateDashboard() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthJourneys = journeys.filter(j => {
                const jDate = new Date(j.startTime);
                return jDate.getMonth() === currentMonth && jDate.getFullYear() === currentYear;
            });
            
            // Totales del mes
            const monthTotalBruto = monthJourneys.reduce((sum, j) => sum + (j.earnings?.bruta || 0), 0);
            const monthTotalFuel = monthJourneys.reduce((sum, j) => sum + (j.earnings?.fuel || 0), 0);
            const monthTotalMoto = monthJourneys.reduce((sum, j) => sum + (j.earnings?.moto || 0), 0);
            const monthTotalPersonal = monthJourneys.reduce((sum, j) => sum + (j.earnings?.personal || 0), 0);
            
            const cuotaMoto = 475648;
            const disponibleReal = monthTotalBruto - cuotaMoto - monthTotalFuel - monthTotalMoto;
            
            // Actualizar header
            document.getElementById('monthTotal').textContent = formatCurrency(monthTotalBruto);
            
            const journeyCount = monthJourneys.length;
            const dailyAvgBruto = journeyCount > 0 ? monthTotalBruto / journeyCount : 0;
            const dailyAvgNeto = journeyCount > 0 ? monthJourneys.reduce((sum, j) => sum + (j.earnings?.neta || 0), 0) / journeyCount : 0;
            
            document.getElementById('dailyAvg').textContent = formatCurrency(dailyAvgBruto);
            
            // Card de recaudaci√≥n
            document.getElementById('progressAmount').textContent = formatCurrency(monthTotalBruto);
            document.getElementById('totalFuel').textContent = '-' + formatCurrency(monthTotalFuel);
            document.getElementById('totalMoto').textContent = '-' + formatCurrency(monthTotalMoto);
            document.getElementById('realAvailable').textContent = formatCurrency(disponibleReal);
            document.getElementById('totalPersonal').textContent = formatCurrency(monthTotalPersonal);
            
            // C√ÅLCULO MDA ‚Äî con fecha de inicio configurable
            const workStartDay = 7; // Marzo arranca el d√≠a 7
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = now.getDate();
            const totalWorkDays = daysInMonth - workStartDay + 1; // 25 d√≠as (07 al 31)
            const daysRemaining = Math.max(0, daysInMonth - today);
            
            const avgFuelPerDay = journeyCount > 0 ? monthTotalFuel / journeyCount : 5000;
            const avgMotoPerDay = journeyCount > 0 ? monthTotalMoto / journeyCount : 2000;
            const estimatedRemainingExpenses = (avgFuelPerDay + avgMotoPerDay) * daysRemaining;
            
            const totalNeeded = cuotaMoto + monthTotalFuel + monthTotalMoto + estimatedRemainingExpenses;
            const stillNeeded = totalNeeded - monthTotalBruto;
            
            let dailyGoalDynamic = 40000;
            if (daysRemaining > 0 && stillNeeded > 0) {
                dailyGoalDynamic = Math.ceil(stillNeeded / daysRemaining);
            } else if (daysRemaining > 0) {
                dailyGoalDynamic = Math.ceil(dailyAvgBruto);
            }
            
            document.getElementById('dailyGoalDynamic').textContent = formatCurrency(dailyGoalDynamic);
            document.getElementById('neededForQuota').textContent = formatCurrency(Math.max(0, cuotaMoto + monthTotalFuel + monthTotalMoto - monthTotalBruto));
            document.getElementById('estimatedOperativeExpenses').textContent = formatCurrency(estimatedRemainingExpenses);
            document.getElementById('daysRemaining').textContent = daysRemaining;
            
            // Mensaje de estado
            const goalStatus = document.getElementById('goalStatus');
            if (stillNeeded <= 0) {
                goalStatus.textContent = 'üéâ ¬°Ya cubriste la cuota y gastos operativos!';
                goalStatus.style.background = 'rgba(74, 222, 128, 0.2)';
                goalStatus.style.border = '1px solid var(--accent-green)';
                goalStatus.style.color = 'var(--accent-green)';
            } else if (dailyGoalDynamic > dailyAvgBruto * 1.5) {
                goalStatus.textContent = '‚ö†Ô∏è Necesitas aumentar el ritmo para llegar';
                goalStatus.style.background = 'rgba(248, 113, 113, 0.2)';
                goalStatus.style.border = '1px solid var(--accent-red)';
                goalStatus.style.color = 'var(--accent-red)';
            } else if (dailyGoalDynamic > dailyAvgBruto) {
                goalStatus.textContent = 'üìà Vas bien, mant√©n el esfuerzo';
                goalStatus.style.background = 'rgba(251, 146, 60, 0.2)';
                goalStatus.style.border = '1px solid var(--accent-orange)';
                goalStatus.style.color = 'var(--accent-orange)';
            } else {
                goalStatus.textContent = '‚úÖ ¬°Vas por buen camino!';
                goalStatus.style.background = 'rgba(74, 222, 128, 0.2)';
                goalStatus.style.border = '1px solid var(--accent-green)';
                goalStatus.style.color = 'var(--accent-green)';
            }
            
            // Stats
            document.getElementById('journeyCount').textContent = journeyCount;
            document.getElementById('dailyAvgBruto').textContent = formatCurrency(dailyAvgBruto);
            document.getElementById('dailyAvgNeto').textContent = formatCurrency(dailyAvgNeto);
            
            // Proyecciones
            const projectionBruto = dailyAvgBruto * totalWorkDays;
            const projectionFuel = monthTotalFuel + (avgFuelPerDay * daysRemaining);
            const projectionMoto = monthTotalMoto + (avgMotoPerDay * daysRemaining);
            const projectionNeto = projectionBruto - cuotaMoto - projectionFuel - projectionMoto;
            
            document.getElementById('projectionBruto').textContent = formatCurrency(projectionBruto);
            document.getElementById('projectionNeto').textContent = formatCurrency(projectionNeto);
            
            const totalKm = journeys.reduce((sum, j) => sum + (j.kmTraveled || 0), 0);
            document.getElementById('totalKm').textContent = totalKm.toFixed(0);

            // ===== FRASCOS =====
            const metaBase = 30000; // Por d√≠a
            let frascosCuota = 0;
            let frascosAhorro = 0;

            monthJourneys.forEach(j => {
                const bruta = j.earnings?.bruta || 0;
                if (bruta >= metaBase) {
                    frascosCuota += metaBase;
                    frascosAhorro += (bruta - metaBase);
                } else {
                    frascosCuota += bruta;
                }
            });

            const cuotaPct = Math.min(100, Math.round((frascosCuota / cuotaMoto) * 100));
            const cuotaFalta = Math.max(0, cuotaMoto - frascosCuota);

            document.getElementById('frascoCuotaAmount').textContent = formatCurrency(frascosCuota);
            document.getElementById('frascoCuotaPct').textContent = cuotaPct + '%';
            document.getElementById('frascoCuotaFalta').textContent = cuotaFalta > 0 ? `Faltan ${formatCurrency(cuotaFalta)}` : '‚úÖ Completo';
            document.getElementById('frascoCuotaBar').style.width = cuotaPct + '%';
            document.getElementById('frascoAhorroAmount').textContent = formatCurrency(frascosAhorro);
            document.getElementById('frascoAhorroJornadas').textContent = `${monthJourneys.filter(j => (j.earnings?.bruta || 0) > metaBase).length} jornadas superaron $${(metaBase/1000).toFixed(0)}k`;
        }

        // Actualizar historial
        function updateHistory() {
            const historyList = document.getElementById('historyList');
            
            if (journeys.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div>No hay jornadas registradas</div>
                    </div>
                `;
                return;
            }
            
            const sortedJourneys = [...journeys].reverse();
            
            historyList.innerHTML = sortedJourneys.map(journey => {
                const date = new Date(journey.startTime);
                const dateStr = date.toLocaleDateString('es-AR', { 
                    day: '2-digit', 
                    month: '2-digit',
                    year: 'numeric'
                });
                const timeStr = date.toLocaleTimeString('es-AR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="history-item">
                        <div class="history-header">
                            <div>
                                <div class="history-date">${dateStr}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${timeStr}</div>
                            </div>
                            <div class="history-earning">${formatCurrency(journey.earnings?.neta || 0)}</div>
                        </div>
                        <div class="history-details">
                            <div class="history-detail">
                                <span>KM:</span>
                                <span>${journey.kmTraveled?.toFixed(0) || 0}</span>
                            </div>
                            <div class="history-detail">
                                <span>Combustible:</span>
                                <span>-${formatCurrency(journey.earnings?.fuel || 0)}</span>
                            </div>
                            <div class="history-detail">
                                <span>Gastos Moto:</span>
                                <span>-${formatCurrency(journey.earnings?.moto || 0)}</span>
                            </div>
                            <div class="history-detail">
                                <span>Gastos Pers.:</span>
                                <span>-${formatCurrency(journey.earnings?.personal || 0)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Formatear moneda
        function formatCurrency(amount) {
            return '$' + amount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Cerrar modales al hacer clic fuera
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Exportar datos
        function exportData() {
            const data = {
                exportDate: new Date().toISOString(),
                journeys: JSON.parse(localStorage.getItem('journeys') || '[]'),
                activeJourney: JSON.parse(localStorage.getItem('activeJourney') || 'null')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const fecha = new Date().toLocaleDateString('es-AR').replace(/\//g, '-');
            a.href = url;
            a.download = `uber-tracker-backup-${fecha}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Importar datos
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.journeys) {
                        alert('Archivo inv√°lido');
                        return;
                    }
                    if (!confirm(`¬øRestaurar backup del ${new Date(data.exportDate).toLocaleDateString('es-AR')}? Se reemplazar√°n los datos actuales.`)) return;
                    localStorage.setItem('journeys', JSON.stringify(data.journeys));
                    if (data.activeJourney) {
                        localStorage.setItem('activeJourney', JSON.stringify(data.activeJourney));
                    } else {
                        localStorage.removeItem('activeJourney');
                    }
                    loadData();
                    updateDashboard();
                    updateHistory();
                    checkActiveJourney();
                    alert('‚úÖ Backup restaurado correctamente');
                } catch(err) {
                    alert('Error al leer el archivo: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Inicializar al cargar
        init();
    </script>
</body>
</html>
